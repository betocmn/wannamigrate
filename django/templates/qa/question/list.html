{% extends "_layouts/main.html" %}
{% load staticfiles %}
{% load i18n %}
{% load string_extras %}

{% block head %}
    {{ block.super }}
    <style>
        #loading-gif
        {
            display:none;
            width: 32px;
            height:32px;
            z-index:100;
            background-image : url( '{% static "site/img/loading.gif" %}');
            position:relative;
            margin:0 auto;
        }

        #loading-gif.show{ display:block; }
    </style>
{% endblock head %}

{% block content %}
    <div class="content social">
        {% include "qa/common/side_menu.html" %}
        <section class="content">
            <div class="questions-answers">
                <!--a href="{% url "qa:add_question" %}" class="button bt-addQuestion">{% trans 'Add Question' context 'button' %}</a-->

                <div class="add-question" style="padding:20px; background:#efefef;">
                    <div class="want-know" style="padding-bottom:20px !important;">
                        <h2 class="title">{% trans 'What do you want to know?' %}</h2>
                        <textarea style="background:white;" cols="40" id="question-title-form" name="title" placeholder="{% trans 'Type your question here...' %}" rows="10"></textarea>
                    </div>
                    <button class="button bt-add-question">{% trans 'Add Question' context 'button' %}</button>
                </div>

                <div class="content-questionsAnswers">
                    {% include "qa/question/list_group.html" with questions=questions %}
                    <div id="loading-gif"></div>
                </div>
            </div>
        </section>
    </div>

{% endblock content %}


{% block scripts %}

    {{ block.super }}

    <!-- JS REQUIRED BY THIS PAGE -->
    <script type="text/javascript" src="{% static 'common/trunk8/js/trunk8.js' %}"></script>
    <script type="text/javascript" src="{% static 'site/js/questions_answers.js' %}"></script>

    <!-- INLINE JS -->
    <script type="text/javascript">
        var step = {{ next_step }};
        var request_locked = false;
        var loading_ended = false;

        $( document ).ready( function() {

            // XToggleButton Handler
            $( document ).on( "click", ".x-toggle-button", { redirect_url : "{% url "site:login" %}" }, onXToggleButtonClicked );

            $( "button.bt-add-question" ).click(function(){
                question = $( "textarea#question-title-form" ).val().toString();
                if ( question.length == 0 ) {
                    alert("{% trans 'Ask something' %}");
                    $( "textarea#question-title-form" ).focus();
                }
                else
                    window.location = "{% url 'qa:add_question' %}?q=" + question;
            });


            $( window ).scroll( function(){
                var GAP = 300; /* 300pxs gap */
                var reached_bottom = $( window ).scrollTop() >= ( $( document ).height() - $( window ).height() - GAP );

                if ( ! request_locked && ! loading_ended && reached_bottom )
                {
                    // Locks requests and shows the loading gif.
                    request_locked = true;
                    $( "#loading-gif" ).addClass( "show" );

                    var request_url = "{% url "qa:ajax_load_questions" %}" + "?step=" + step + {% autoescape off %} "&{{filter_params}}" {% endautoescape %}
                    // requesting...
                    var request = $.get(
                        request_url
                    ).done( function( data ){
                        $('#loading-gif').before( data );
                        step++;
                    }).fail( function( httpObj, text ){
                        // Unauthorized?
                        if ( httpObj.status == 401 )
                            window.location.href = "{% url "site:login" %}";
                        else if ( httpObj.status == 404 )
                        {
                            // End of content
                            $('#loading-gif').before( $( "<div>" ).html( "{% trans "No more results" %}" ) );
                            loading_ended = true;
                        }
                    }).always( function(){
                        $( "#loading-gif" ).removeClass( "show" );
                        request_locked = false;
                    });
                }
            });
        });


    </script>

    {% include "_layouts/analytics.html" %}

{% endblock scripts %}