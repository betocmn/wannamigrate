{% extends "_layouts/main.html" %}
{% load staticfiles %}
{% load i18n %}
{% load string_extras %}

{% block head %}
    {{ block.super }}
    <link href="{% static 'common/jquery-ui/css/ui-lightness/jquery-ui.css' %}" rel="stylesheet">
    <link href="{% static 'common/font-awesome/css/font-awesome.css' %}" rel="stylesheet">
    <style>
        .ui-autocomplete-loading { background:url('{% static "admin/img/loading.gif" %}') no-repeat right center }

        #search-topics::before
        {
            content: "";
            background: transparent url('{% static "site/img/icon-lupa.png" %}') no-repeat scroll 0px 0px;
            width: 35px;
            height: 35px;
            position: absolute;
            display: block;
            border: 0px none;
            text-indent: -9999px;
            overflow: hidden;
        }

        .bt-remove { cursor:pointer }
        .bt-remove:hover { color:purple; }
    </style>
{% endblock head %}

{% block content %}
    <div class="content social">
        {% include "qa/common/side_menu.html" %}
        <section class="content">
            <div class="question-following">
                <div id="topics">
                    <form id="add-topic-form" action="#" class="add-interest">
                        <h2 class="title">Add interest...</h2>
                        <input id="search-topics" type="text" placeholder="Ex. Brasil">
                        <!--button class="button bt-add">Add</button-->
                    </form>
                    <div class="tags">
                        <h2 class="title">Your interests</h2>
                        <ul class="tags-list"></ul>
                    </div>
                </div>
            </div>
        </section>
    </div>
{% endblock content %}

{% block scripts %}

    {{ block.super }}

    <!-- JS REQUIRED BY THIS PAGE -->
    <script src="{% static 'common/jquery-ui/js/jquery-ui.js' %}"></script>
    <script type="text/javascript" src="{% static 'site/js/questions_answers.js' %}"></script>

    <!-- INLINE JS -->
    <script type="text/javascript">
        var following_topics = {
            "__size__" : 0
        };

        {% for topic in following_topics %}
            addTopic( { "id" : {{ topic.id }}, "value" : "{{ topic.name }}", "view_url" : "{% url "qa:view_topic" topic.slug %}", "follow_url" : "{% url "qa:ajax_follow_topic" topic.id %}", "unfollow_url" : "{% url "qa:ajax_unfollow_topic" topic.id %}" } );
        {% endfor %}


        function addTopic( topic )
        {
            if ( !( topic.id in following_topics ) )
            {
                // Adds the topic to the list of following topics.
                following_topics[ topic.id ] = topic;
                following_topics[ "__size__" ]++;

                // Get some topic's values
                id = topic[ "id" ];
                name = topic[ "value" ];
                view_url = topic[ "view_url" ];

                // Creates the remove buttom
                var i_close = $( "<i>" ).attr( "class", "fa fa-close bt-remove" ).attr( "onclick", "removeTopic( event, " + id + ");" );
                // Creates the anchor
                var anchor = $( "<a>" ).attr( "href", view_url ).attr( "class", "tag-link" ).text( name );
                // Creates the topic tag
                var topic_tag = $( "<li>" ).attr( "class", "tag" );

                // Appends everything
                $( "div.tags > ul.tags-list" ).append( topic_tag.append( anchor.append( i_close ) ) );

                // Updates the following topics counter
                updateFollowingTopicsCounter( following_topics[ "__size__" ] );
            }
        }

        function removeTopic( event, id )
        {
            event.preventDefault();

            if ( id in following_topics )
            {
                var elm = $( event.target );
                $.get( following_topics[ id ][ "unfollow_url" ], { "_": $.now() }, function( data ){
                    delete following_topics[ id ];
                    following_topics[ "__size__" ]--;

                    elm.closest( "li" ).remove();

                    updateFollowingTopicsCounter( following_topics[ "__size__" ] );
                });
            }
        }


        $( document ).ready( function() {
            var cache = {};
            $( "#search-topics" ).autocomplete({
                minLength: 2,
                source: function( request, response ) {
                    var term = request.term;
                    if ( term in cache ) {
                      response( cache[ term ] );
                      return;
                    }
                    $.getJSON( "{% url "qa:ajax_get_topics" %}", request, function( data, status, xhr ) {
                      cache[ term ] = data;
                      response( data );
                    }).fail(function(httpObj, text){
                        if ( httpObj.status == 401 )
                            window.location.href = evt.data.redirect_url;
                    });
                },

                select: function( event, ui ) {
                    // Adds the topic to the user interests
                    $.get( ui.item[ "follow_url" ], { "_": $.now() }, function( data ){
                        // Adds the topic
                        addTopic( ui.item );
                        // Clears the input text
                        $( "#search-topics" ).val( "" );
                    }).fail(function(httpObj, text){
                        if ( httpObj.status == 401 )
                            window.location.href = "{% url "site:login" %}";
                    });
                }
            });

        });
    </script>


    {% include "_layouts/analytics.html" %}

{% endblock scripts %}